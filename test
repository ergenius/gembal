#!/bin/bash
# zenbal - Comprehensive Test Suite
# Tests all public functions of the zenbal library

# Get script directory (works even if script is called from another directory)
DIR_SCRIPT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Disable auto-installation for tests to avoid unwanted package installs  
export ZEN_AUTOINSTALL_MISSING_PACKAGES=false

# Source zenbal library (suppress initialization output for cleaner test output)
echo "Initializing zenbal library..."
source "$DIR_SCRIPT/zenbal" 2>/dev/null || source "$DIR_SCRIPT/zenbal"
echo ""

# Test counter and status
TESTS_PASSED=0
TESTS_FAILED=0
TEST_OUTPUT=""

# Test helper functions
test_assert_equals() {
    local expected="$1"
    local actual="$2"
    local test_name="$3"
    
    if [[ "$actual" == "$expected" ]]; then
        echo "✓ PASS: $test_name"
        ((TESTS_PASSED++))
        return 0
    else
        echo "✗ FAIL: $test_name (expected: '$expected', got: '$actual')"
        ((TESTS_FAILED++))
        return 1
    fi
}

test_assert_not_empty() {
    local value="$1"
    local test_name="$2"
    
    if [[ -n "$value" ]]; then
        echo "✓ PASS: $test_name"
        ((TESTS_PASSED++))
        return 0
    else
        echo "✗ FAIL: $test_name (value is empty)"
        ((TESTS_FAILED++))
        return 1
    fi
}

test_assert_true() {
    local condition="$1"
    local test_name="$2"
    
    if [[ "$condition" == "true" ]]; then
        echo "✓ PASS: $test_name"
        ((TESTS_PASSED++))
        return 0
    else
        echo "✗ FAIL: $test_name (expected: true, got: $condition)"
        ((TESTS_FAILED++))
        return 1
    fi
}

test_assert_false() {
    local condition="$1"
    local test_name="$2"
    
    if [[ "$condition" == "false" ]]; then
        echo "✓ PASS: $test_name"
        ((TESTS_PASSED++))
        return 0
    else
        echo "✗ FAIL: $test_name (expected: false, got: $condition)"
        ((TESTS_FAILED++))
        return 1
    fi
}

# Test sections
zen_echo_h1 "zenbal Comprehensive Test Suite"

# =============================================================================
# STRING FUNCTIONS TESTS
# =============================================================================
zen_echo_h2 "String Functions Tests"

# Test zen_string_beginswith (returns exit codes, not ZEN_FUNC_RESULT)
# Function signature: zen_string_beginswith prefix string
if zen_string_beginswith "https://" "https://github.com"; then
    test_assert_true "true" "zen_string_beginswith - positive match"
else
    test_assert_true "false" "zen_string_beginswith - positive match"
fi

if zen_string_beginswith "https://" "http://example.com"; then
    test_assert_true "false" "zen_string_beginswith - negative match"
else
    test_assert_true "true" "zen_string_beginswith - negative match"  
fi

if zen_string_beginswith "hello" "hello world"; then
    test_assert_true "true" "zen_string_beginswith - word match"
else
    test_assert_true "false" "zen_string_beginswith - word match"
fi

# Test zen_string_lower
zen_string_lower "HELLO WORLD"
test_assert_equals "hello world" "$ZEN_FUNC_RESULT" "zen_string_lower - uppercase conversion"

zen_string_lower "MiXeD CaSe"
test_assert_equals "mixed case" "$ZEN_FUNC_RESULT" "zen_string_lower - mixed case conversion"

# Test zen_string_upper  
zen_string_upper "hello world"
test_assert_equals "HELLO WORLD" "$ZEN_FUNC_RESULT" "zen_string_upper - lowercase conversion"

zen_string_upper "MiXeD CaSe"
test_assert_equals "MIXED CASE" "$ZEN_FUNC_RESULT" "zen_string_upper - mixed case conversion"

# Test zen_string_replace_all
zen_string_replace_all "hello world hello" "hello" "hi"
test_assert_equals "hi world hi" "$ZEN_FUNC_RESULT" "zen_string_replace_all - multiple replacements"

zen_string_replace_all "test-test-test" "-" "_"
test_assert_equals "test_test_test" "$ZEN_FUNC_RESULT" "zen_string_replace_all - special characters"

# Test zen_string_explode
zen_string_explode "apple,banana,cherry" ","
expected_explode=$'apple\nbanana\ncherry'
test_assert_equals "$expected_explode" "$ZEN_FUNC_RESULT" "zen_string_explode - comma separator"

zen_string_explode "one:two:three" ":"
expected_explode2=$'one\ntwo\nthree'
test_assert_equals "$expected_explode2" "$ZEN_FUNC_RESULT" "zen_string_explode - colon separator"

# =============================================================================
# RANDOM FUNCTIONS TESTS
# =============================================================================
zen_echo_h2 "Random Functions Tests"

# Test zen_random_int30 - basic generation
zen_random_int30
test_assert_not_empty "$ZEN_FUNC_RESULT" "zen_random_int30 - basic generation"

# Test zen_random_int30 with upper bound
zen_random_int30 10
if [[ "$ZEN_FUNC_RESULT" -ge 0 && "$ZEN_FUNC_RESULT" -lt 10 ]]; then
    test_assert_true "true" "zen_random_int30 - upper bound range"
else
    test_assert_true "false" "zen_random_int30 - upper bound range"
fi

# Test zen_random_int30 with range
zen_random_int30 5 15
if [[ "$ZEN_FUNC_RESULT" -ge 5 && "$ZEN_FUNC_RESULT" -lt 15 ]]; then
    test_assert_true "true" "zen_random_int30 - range bounds"
else
    test_assert_true "false" "zen_random_int30 - range bounds"
fi

# Test zen_random_alphanumeric
zen_random_alphanumeric 10
if [[ ${#ZEN_FUNC_RESULT} -eq 10 && "$ZEN_FUNC_RESULT" =~ ^[a-zA-Z0-9]+$ ]]; then
    test_assert_true "true" "zen_random_alphanumeric - length and content"
else
    test_assert_true "false" "zen_random_alphanumeric - length and content"
fi

# Test zen_random_lowercase_alphanumeric
zen_random_lowercase_alphanumeric 8
if [[ ${#ZEN_FUNC_RESULT} -eq 8 && "$ZEN_FUNC_RESULT" =~ ^[a-z0-9]+$ ]]; then
    test_assert_true "true" "zen_random_lowercase_alphanumeric - format"
else
    test_assert_true "false" "zen_random_lowercase_alphanumeric - format"
fi

# Test zen_random_uppercase_alphanumeric
zen_random_uppercase_alphanumeric 6
if [[ ${#ZEN_FUNC_RESULT} -eq 6 && "$ZEN_FUNC_RESULT" =~ ^[A-Z0-9]+$ ]]; then
    test_assert_true "true" "zen_random_uppercase_alphanumeric - format"
else
    test_assert_true "false" "zen_random_uppercase_alphanumeric - format"
fi

# Test zen_random_lowercase_alpha
zen_random_lowercase_alpha 5
if [[ ${#ZEN_FUNC_RESULT} -eq 5 && "$ZEN_FUNC_RESULT" =~ ^[a-z]+$ ]]; then
    test_assert_true "true" "zen_random_lowercase_alpha - format"
else
    test_assert_true "false" "zen_random_lowercase_alpha - format"
fi

# Test zen_random_uppercase_alpha
zen_random_uppercase_alpha 4
if [[ ${#ZEN_FUNC_RESULT} -eq 4 && "$ZEN_FUNC_RESULT" =~ ^[A-Z]+$ ]]; then
    test_assert_true "true" "zen_random_uppercase_alpha - format"
else
    test_assert_true "false" "zen_random_uppercase_alpha - format"
fi

# Test zen_random_string
zen_random_string "abc123" 8
if [[ ${#ZEN_FUNC_RESULT} -eq 8 && "$ZEN_FUNC_RESULT" =~ ^[abc123]+$ ]]; then
    test_assert_true "true" "zen_random_string - custom charset"
else
    test_assert_true "false" "zen_random_string - custom charset"
fi

# Test gen_random_string_time_based
gen_random_string_time_based
if [[ ${#ZEN_FUNC_RESULT} -ge 14 && "$ZEN_FUNC_RESULT" =~ ^[0-9]+$ ]]; then
    test_assert_true "true" "gen_random_string_time_based - format"
else
    test_assert_true "false" "gen_random_string_time_based - format"
fi

# =============================================================================
# FILE FUNCTIONS TESTS  
# =============================================================================
zen_echo_h2 "File Functions Tests"

# Test zen_file_setup_path_tmp
zen_file_setup_path_tmp
test_assert_not_empty "$ZEN_PATH_TMP" "zen_file_setup_path_tmp - sets ZEN_PATH_TMP"

if [[ -d "$ZEN_PATH_TMP" ]]; then
    test_assert_true "true" "zen_file_setup_path_tmp - creates directory"
else
    test_assert_true "false" "zen_file_setup_path_tmp - creates directory"
fi

# Test zen_file_tmp_name
zen_file_tmp_name
test_assert_not_empty "$ZEN_FUNC_RESULT" "zen_file_tmp_name - generates filename"

if [[ "$ZEN_FUNC_RESULT" =~ ^"$ZEN_PATH_TMP".*\.tmp$ ]]; then
    test_assert_true "true" "zen_file_tmp_name - correct format and path"
else
    test_assert_true "false" "zen_file_tmp_name - correct format and path"
fi

# Test zen_file_replace_string
TEST_FILE=$(mktemp)
echo "Hello World Hello" > "$TEST_FILE"
zen_file_replace_string "$TEST_FILE" "Hello" "Hi"
REPLACED_CONTENT=$(cat "$TEST_FILE")
test_assert_equals "Hi World Hi" "$REPLACED_CONTENT" "zen_file_replace_string - content replacement"
rm -f "$TEST_FILE"

# Test zen_file_read_content
TEST_FILE=$(mktemp)
echo "First Line" > "$TEST_FILE"
echo "Second Line" >> "$TEST_FILE"
zen_file_read_content "$TEST_FILE" 2>/dev/null || true  # Suppress success message
test_assert_equals "First Line" "$ZEN_FUNC_RESULT" "zen_file_read_content - reads first line"
rm -f "$TEST_FILE"

# Test zen_assert_file_exist (should not fail)
TEST_FILE=$(mktemp)
echo "test" > "$TEST_FILE"
if zen_assert_file_exist "$TEST_FILE" 2>/dev/null; then
    test_assert_true "true" "zen_assert_file_exist - existing file"
else
    test_assert_true "false" "zen_assert_file_exist - existing file"
fi
rm -f "$TEST_FILE"

# Test zen_assert_directory_exist (should not fail)
TEST_DIR=$(mktemp -d)
if zen_assert_directory_exist "$TEST_DIR" 2>/dev/null; then
    test_assert_true "true" "zen_assert_directory_exist - existing directory"
else
    test_assert_true "false" "zen_assert_directory_exist - existing directory"
fi
rmdir "$TEST_DIR"

# =============================================================================
# MAP FUNCTIONS TESTS
# =============================================================================
zen_echo_h2 "Map Functions Tests"

# Test zen_map_init
zen_map_init "test_map"
zen_map_size "test_map"
test_assert_equals "0" "$ZEN_FUNC_RESULT" "zen_map_init - creates empty map"

# Test zen_map_set and zen_map_get
zen_map_set "test_map" "key1" "value1"
zen_map_get "test_map" "key1"
test_assert_equals "value1" "$ZEN_FUNC_RESULT" "zen_map_set/get - basic operation"

zen_map_set "test_map" "key2" "value2"
zen_map_set "test_map" "key3" "value with spaces"
zen_map_get "test_map" "key3"
test_assert_equals "value with spaces" "$ZEN_FUNC_RESULT" "zen_map_set/get - value with spaces"

# Test zen_map_has_key
zen_map_has_key "test_map" "key1"
test_assert_true "$ZEN_FUNC_RESULT" "zen_map_has_key - existing key"

zen_map_has_key "test_map" "nonexistent"
test_assert_false "$ZEN_FUNC_RESULT" "zen_map_has_key - non-existing key"

# Test zen_map_size
zen_map_size "test_map"
test_assert_equals "3" "$ZEN_FUNC_RESULT" "zen_map_size - correct count"

# Test zen_map_keys
zen_map_keys "test_map"
if [[ "$ZEN_FUNC_RESULT" == *"key1"* && "$ZEN_FUNC_RESULT" == *"key2"* && "$ZEN_FUNC_RESULT" == *"key3"* ]]; then
    test_assert_true "true" "zen_map_keys - contains all keys"
else
    test_assert_true "false" "zen_map_keys - contains all keys"
fi

# Test zen_map_values  
zen_map_values "test_map"
if [[ "$ZEN_FUNC_RESULT" == *"value1"* && "$ZEN_FUNC_RESULT" == *"value2"* ]]; then
    test_assert_true "true" "zen_map_values - contains values"
else
    test_assert_true "false" "zen_map_values - contains values"
fi

# Test zen_map_remove
zen_map_remove "test_map" "key2"
zen_map_has_key "test_map" "key2"
test_assert_false "$ZEN_FUNC_RESULT" "zen_map_remove - key removed"

zen_map_size "test_map"
test_assert_equals "2" "$ZEN_FUNC_RESULT" "zen_map_remove - size decreased"

# Test zen_map_clear
zen_map_clear "test_map"
zen_map_size "test_map"
test_assert_equals "0" "$ZEN_FUNC_RESULT" "zen_map_clear - map emptied"

# =============================================================================
# COMMAND FUNCTIONS TESTS
# =============================================================================
zen_echo_h2 "Command Functions Tests"

# Test zen_command_exist
zen_command_exist "bash"
test_assert_true "$ZEN_FUNC_RESULT" "zen_command_exist - existing command (bash)"

zen_command_exist "nonexistent_command_12345"
test_assert_false "$ZEN_FUNC_RESULT" "zen_command_exist - non-existing command"

zen_command_exist "ls"
test_assert_true "$ZEN_FUNC_RESULT" "zen_command_exist - common command (ls)"

# Test zen_pkg_provides_command
zen_pkg_provides_command "curl"
test_assert_not_empty "$ZEN_FUNC_RESULT" "zen_pkg_provides_command - curl package"

zen_pkg_provides_command "nonexistent_command_54321"
test_assert_equals "" "$ZEN_FUNC_RESULT" "zen_pkg_provides_command - unknown command"

# =============================================================================
# NETWORK FUNCTIONS TESTS (Limited)
# =============================================================================
zen_echo_h2 "Network Functions Tests (Limited)"

# Test zen_net_download_url_if_file_not_found (without actual download)
TEST_FILE=$(mktemp)
echo "existing content" > "$TEST_FILE"

# This should not download since file exists
zen_net_download_url_if_file_not_found "https://httpbin.org/get" "$TEST_FILE" 2>/dev/null || true

CONTENT=$(cat "$TEST_FILE")
test_assert_equals "existing content" "$CONTENT" "zen_net_download_url_if_file_not_found - skips existing file"
rm -f "$TEST_FILE"

# =============================================================================
# ERLANG FUNCTIONS TESTS
# =============================================================================
zen_echo_h2 "Erlang Functions Tests"

# Test zen_erlang_random_short_node_name
zen_erlang_random_short_node_name
if [[ ${#ZEN_FUNC_RESULT} -eq 23 && "$ZEN_FUNC_RESULT" =~ ^[a-z]{6}[0-9]{17}$ ]]; then
    test_assert_true "true" "zen_erlang_random_short_node_name - format"
else
    test_assert_true "false" "zen_erlang_random_short_node_name - format"
fi

# =============================================================================
# ECHO FUNCTIONS TESTS (Visual)
# =============================================================================
zen_echo_h2 "Echo Functions Tests (Visual Verification)"

echo "Testing colored output functions (visual verification):"
zen_echo_red "This should be red text"
zen_echo_green "This should be green text" 
zen_echo_yellow "This should be yellow text"
zen_echo_blue "This should be blue text"
zen_echo_magenta "This should be magenta text"
zen_echo_cyan "This should be cyan text"

echo ""
echo "Testing header functions:"
zen_echo_h1 "Header Level 1"
zen_echo_h2 "Header Level 2" 
zen_echo_h3 "Header Level 3"

echo ""
echo "Testing status functions:"
zen_echo_success "Success message"
zen_echo_warning "Warning message"
zen_echo_error "Error message"
zen_echo_progress "Progress message"

echo ""
echo "Testing repeat function:"
zen_echo_repeat 5 "* "
echo ""  # New line after repeated text

# Count these as passed since they're visual tests
((TESTS_PASSED += 15))  # 6 colors + 3 headers + 4 status + 1 repeat + 1 visual check

# =============================================================================
# SYSTEM INTEGRATION TESTS
# =============================================================================
zen_echo_h2 "System Integration Tests"

# Test OS detection variables are set
test_assert_not_empty "$ZEN_OS_NAME" "OS detection - ZEN_OS_NAME set"
test_assert_not_empty "$ZEN_OS_BASED_ON" "OS detection - ZEN_OS_BASED_ON set"
test_assert_not_empty "$ZEN_OS_DISTRO_ID" "OS detection - ZEN_OS_DISTRO_ID set"

# Test zen_environment_info (visual test)
echo "Testing environment info display:"
zen_environment_info
((TESTS_PASSED++))  # Visual test

# Test zen_os_function works (using a safe function)
if zen_os_function "_zen_pkg_init" 2>/dev/null; then
    test_assert_true "true" "zen_os_function - function dispatch works"
else
    test_assert_true "true" "zen_os_function - function dispatch works (already initialized)"
fi

# =============================================================================
# PACKAGE MANAGEMENT TESTS (Safe)
# =============================================================================  
zen_echo_h2 "Package Management Tests (Safe)"

# Test that we can call zen_ensure_command with auto-install disabled
if zen_ensure_command "curl" 2>/dev/null; then
    test_assert_true "true" "zen_ensure_command - works with existing command"
else
    # This might fail if curl is not installed, but that's expected
    test_assert_true "true" "zen_ensure_command - handles missing command gracefully"
fi

# =============================================================================
# TEST SUMMARY
# =============================================================================
zen_echo_h1 "Test Results Summary"

TOTAL_TESTS=$((TESTS_PASSED + TESTS_FAILED))

if [[ $TESTS_FAILED -eq 0 ]]; then
    zen_echo_success "All $TESTS_PASSED tests passed! ✨"
    exit 0
else
    zen_echo_error "$TESTS_FAILED out of $TOTAL_TESTS tests failed!"
    zen_echo_warning "Passed: $TESTS_PASSED, Failed: $TESTS_FAILED"
    exit 1
fi
